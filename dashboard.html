<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CORE Control Center - Smart Tech</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        :root { --neon-green: #00ff41; --dark-bg: #050505; --alert-red: #ff0000; --off-blue: #4488ff; }
        
        body {
            margin: 0; background: var(--dark-bg); color: var(--neon-green);
            font-family: 'Courier New', monospace; 
            display: flex; flex-direction: column; 
            height: 100vh; overflow: hidden;
        }
        
        header {
            height: 60px; padding: 0 15px; border-bottom: 2px solid var(--neon-green);
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(0, 20, 0, 0.9); z-index: 1001;
        }

        #map { flex: 1; width: 100%; filter: invert(100%) hue-rotate(180deg) brightness(0.6) contrast(1.2); }
        
        /* Panel Ultra Compacto */
        .panel-alertas { 
            height: 150px; 
            background: #000; 
            overflow-y: auto; 
            border-top: 2px solid var(--neon-green); 
            padding: 8px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); 
            gap: 8px;
        }

        /* Tarjeta Mini con BotÃ³n de Cierre */
        .alert-card { 
            position: relative;
            border: 1px solid #222; 
            border-top: 2px solid var(--alert-red); 
            background: #0a0a0a; 
            padding: 5px; 
            font-size: 0.6rem; 
            display: flex; 
            flex-direction: column;
            height: 110px;
            border-radius: 3px;
        }

        .btn-cerrar {
            position: absolute; top: 2px; right: 2px;
            background: rgba(255,0,0,0.2); color: red; border: 1px solid red;
            cursor: pointer; font-size: 8px; padding: 0 3px; border-radius: 2px;
            z-index: 10;
        }
        .btn-cerrar:hover { background: red; color: white; }

        .alert-card.system-off { border-top-color: var(--off-blue); }

        .alert-card img { 
            width: 100%; height: 50px; object-fit: cover; 
            border: 1px solid #333; cursor: pointer; margin-top: 4px;
        }

        .stats-hub { display: flex; gap: 20px; font-size: 0.8rem; }
        .stat-box { border: 1px solid var(--neon-green); padding: 5px 10px; background: rgba(0,255,65,0.05); }
        .stat-num { color: white; font-weight: bold; }
        .radar-icon { background: rgba(255, 0, 0, 0.4); border: 2px solid var(--alert-red); border-radius: 50%; box-shadow: 0 0 15px var(--alert-red); animation: pulse-red 1.5s infinite; }
        @keyframes pulse-red { 0% { transform: scale(0.7); opacity: 1; } 100% { transform: scale(1.6); opacity: 0; } }
        .unit-label { background: rgba(0, 255, 65, 0.2); border: 1px solid var(--neon-green); color: white; padding: 2px 5px; font-size: 10px; border-radius: 4px; text-transform: uppercase; }
        
        #evidencia-flotante { position: fixed; top: 80px; right: 20px; width: 280px; border: 2px solid var(--neon-green); background: rgba(0,0,0,0.9); z-index: 2000; display: none; padding: 10px; box-shadow: 0 0 30px rgba(0,255,65,0.3); border-radius: 8px; }
        #modal-foto { display: none; position: fixed; z-index: 3000; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); align-items: center; justify-content: center; cursor: zoom-out; }
        #modal-foto img { max-width: 90%; max-height: 90%; border: 2px solid var(--neon-green); box-shadow: 0 0 50px rgba(0,255,65,0.5); }
    </style>
</head>
<body>

<header>
    <div>
        <h2 style="margin:0; font-size: 1.1rem;">CORE CONTROL CENTER</h2>
        <small>TRACKING MULTI-UNIDAD - MAR DEL PLATA</small>
    </div>
    <div class="stats-hub">
        <div class="stat-box">ALERTAS: <span id="count-alertas" class="stat-num">0</span></div>
        <div class="stat-box">PUNTOS RUTA: <span id="count-ruta" class="stat-num">0</span></div>
    </div>
    <div id="status-global">SATÃ‰LITE ACTIVO</div>
</header>

<div id="evidencia-flotante">
    <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
        <small style="color:var(--alert-red); font-weight:bold;">ðŸš¨ ALERTA DETECTADA</small>
        <small id="id-unidad" style="color:#888"></small>
    </div>
    <img id="img-evidencia" src="" style="width:100%; border:1px solid var(--neon-green); margin-bottom:5px; cursor:pointer;">
    <div id="info-evidencia" style="font-size:0.7rem; line-height:1.2;"></div>
</div>

<div id="map"></div>

<div class="panel-alertas" id="log-alertas"></div>

<script>
    const SUPABASE_URL = 'https://svpurpvbiujhcbiugrkh.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN2cHVycHZiaXVqaGNiaXVncmtoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3NDgzMTUsImV4cCI6MjA4MzMyNDMxNX0.AivKJ0_N0z_4T4vLNfUcE2hepJ1XXOO8-4fSA3PJXdc';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const map = L.map('map').setView([-37.994, -57.553], 14); 
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    const unidadesActivas = {}; 
    let totalAlertas = 0;
    let totalPuntosRuta = 0;

    const modal = document.createElement('div');
    modal.id = 'modal-foto';
    modal.innerHTML = `<img id="img-zoom" src="">`;
    document.body.appendChild(modal);
    modal.onclick = () => modal.style.display = 'none';

    function ampliarFoto(url) {
        if(!url || url.includes('placeholder')) return;
        document.getElementById('img-zoom').src = url;
        document.getElementById('modal-foto').style.display = 'flex';
    }

    async function cargarHistorico() {
        const { data } = await supabaseClient.from('road_alerts').select('*').order('created_at', { ascending: false }).limit(10);
        if (data) {
            data.reverse().forEach(item => {
                if (item.alert_type === 'RUTA') procesarPuntoRuta(item);
                else addAlertToMap(item, false);
            });
        }
    }

    function iniciarRealtime() {
        supabaseClient.channel('cambios_core').on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'road_alerts' }, payload => {
            const nuevaData = payload.new;
            if (nuevaData.alert_type === 'RUTA') procesarPuntoRuta(nuevaData, true);
            else { addAlertToMap(nuevaData, true); playAlertSound(); }
        }).subscribe();
    }

    function procesarPuntoRuta(data, autoFly = false) {
        const id = data.dispositivo || 'Unidad Desconocida';
        const pos = [data.latitude, data.longitude];
        if (!unidadesActivas[id]) {
            unidadesActivas[id] = {
                ruta: [],
                polyline: L.polyline([], {color: '#00ff41', weight: 4, opacity: 0.6}).addTo(map),
                marker: L.marker(pos, { icon: L.divIcon({ className: 'unit-label', html: `<span>${id}</span>`, iconSize: [80, 20], iconAnchor: [40, 25]}) }).addTo(map)
            };
        }
        unidadesActivas[id].ruta.push(pos);
        unidadesActivas[id].polyline.setLatLngs(unidadesActivas[id].ruta);
        unidadesActivas[id].marker.setLatLng(pos);
        totalPuntosRuta++;
        document.getElementById('count-ruta').innerText = totalPuntosRuta;
        if (autoFly) map.panTo(pos);
    }

    function addAlertToMap(alerta, isNew = false) {
        if (!alerta.latitude || !alerta.longitude) return;
        if (alerta.alert_type !== 'SISTEMA OFF') {
            totalAlertas++;
            document.getElementById('count-alertas').innerText = totalAlertas;
        }
        const radarIcon = L.divIcon({ className: 'radar-icon', iconSize: [20, 20] });
        const marker = L.marker([alerta.latitude, alerta.longitude], { icon: radarIcon }).addTo(map);
        
        if (isNew) {
            map.flyTo([alerta.latitude, alerta.longitude], 16);
            mostrarPanelEvidencia(alerta);
        }
        actualizarLog(alerta);
    }

    function mostrarPanelEvidencia(alerta) {
        if (!alerta.video_url) return;
        const panel = document.getElementById('evidencia-flotante');
        const img = document.getElementById('img-evidencia');
        img.src = alerta.video_url;
        img.onclick = () => ampliarFoto(alerta.video_url);
        document.getElementById('id-unidad').innerText = alerta.dispositivo;
        document.getElementById('info-evidencia').innerHTML = `${alerta.alert_type} | ${alerta.speed_kmh} KM/H`;
        panel.style.display = 'block';
        setTimeout(() => { panel.style.display = 'none'; }, 8000);
    }

    function actualizarLog(alerta) {
        const log = document.getElementById('log-alertas');
        const card = document.createElement('div');
        card.className = `alert-card ${alerta.alert_type === 'SISTEMA OFF' ? 'system-off' : ''}`;
        
        card.innerHTML = `
            <button class="btn-cerrar" onclick="this.parentElement.remove()">X</button>
            <div style="overflow:hidden; white-space:nowrap; text-overflow:ellipsis; font-weight:bold;">
                ${alerta.dispositivo}
            </div>
            <div style="color:#aaa; font-size:7px;">${alerta.alert_type}</div>
            ${alerta.video_url ? `<img src="${alerta.video_url}" onclick="ampliarFoto('${alerta.video_url}')">` : '<div style="height:50px; border:1px solid #111; margin-top:4px;"></div>'}
            <div style="font-size: 7px; color:#444; margin-top:auto; display:flex; justify-content:space-between;">
                <span>${alerta.speed_kmh || 0}KM/H</span>
                <span>${new Date(alerta.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
            </div>
        `;
        log.prepend(card);

        // Auto-limpieza: Solo mantenemos 10 tarjetas visuales
        if (log.children.length > 10) {
            log.removeChild(log.lastChild);
        }
    }

    function playAlertSound() {
        const audio = new (window.AudioContext || window.webkitAudioContext)();
        const osc = audio.createOscillator();
        osc.connect(audio.destination);
        osc.start(); osc.stop(audio.currentTime + 0.1);
    }

    cargarHistorico();
    iniciarRealtime();
</script>
</body>
</html>
